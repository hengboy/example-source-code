# Spring Security & Keycloak整合

> 基于`Spring Boot`基础环境实现`Spring Security`与`Keycloak`认证中心的整合，实现登录回调访后访问受保护的资源。

当我们访问受保护的资源地址时，如：[http://localhost:8080/customer](http://localhost:8080/customer)，会跳转到`Keycloak`授权页面，地址为：`http://localhost:10000/realms/minbox/protocol/openid-connect/auth?response_type=code&client_id=example-learning&redirect_uri=http%3A%2F%2Flocalhost%3A8080%2Fcustomer&state=16e5739e-dfea-401c-9688-598d4b6e0575&login=true&scope=openid`



输入用户名以及密码登录成功后会跳转到`redirect_uri`参数的目标地址，这时我们就可以访问权限允许范围内受保护的资源了。



## RestApi

`Spring Security`整合`Keycloak`后可以保护`RestApi`，获取`AccessToken`，使用令牌可以访问接口资源。

### 1. Session安全策略

**WebSecurityConfig：**

```java
/**
* 定义Session认证的策略
*/
@Bean
@Override
protected SessionAuthenticationStrategy sessionAuthenticationStrategy() {
		return new NullAuthenticatedSessionStrategy();
}
//@Bean
//protected SessionRegistry buildSessionRegistry() {
//    return new SessionRegistryImpl();
// }
```

> 修改Session安全策略为`NullAuthenticatedSessionStrategy`，注释掉Session注册器（`SessionRegistry`）。

### 2. 获取令牌

获取令牌地址：`http://localhost:10000/realms/minbox/protocol/openid-connect/token`

`POST`方式访问接口，参数必须使用`x-www-form-urlencoded`方式传递，参数列表：

- client_id：客户端ID，`example-learning`
- grant_type：授权方式，`password`
- username：用户名，yuqiyu
- password：密码，1234567

**返回数据：**

```json
{
    "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI5eUFlalpDenlfVm1UeEY4WjRBc0tJNThrd2FDRXlsSUFHd1htU2YzYXRFIn0.eyJleHAiOjE2Njc4OTQ0NTcsImlhdCI6MTY2Nzg5NDE1NywianRpIjoiOTY3MTcxZmYtNTljOS00NzUxLTk4YmMtYmNhNjBiYzNmZWExIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDoxMDAwMC9yZWFsbXMvbWluYm94IiwiYXVkIjoiYWNjb3VudCIsInN1YiI6ImNiNDVhZWNhLTk3MzAtNGJlZC1hOTM5LTcxYThlYjA4ODM3NiIsInR5cCI6IkJlYXJlciIsImF6cCI6ImV4YW1wbGUtbGVhcm5pbmciLCJzZXNzaW9uX3N0YXRlIjoiMDYxZTQ4ODUtZGYxOS00ZTU5LTljZGMtZjY1YTMyNGQ2ZTFiIiwiYWNyIjoiMSIsInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsInVtYV9hdXRob3JpemF0aW9uIiwidXNlciIsImRlZmF1bHQtcm9sZXMtbWluYm94Il19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJwcm9maWxlIGVtYWlsIiwic2lkIjoiMDYxZTQ4ODUtZGYxOS00ZTU5LTljZGMtZjY1YTMyNGQ2ZTFiIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInByZWZlcnJlZF91c2VybmFtZSI6Inl1cWl5dSIsImdpdmVuX25hbWUiOiIiLCJmYW1pbHlfbmFtZSI6IiIsImVtYWlsIjoieXVxaXl1QGdtYWlsLmNvbSJ9.eBCxbU0tvPqF7Url6J2IxGceLPZyINiWl-7Aj4TR-oGLVObioNyb854rp3mw2gkI6snGPOCaszGpHANLMNvRQbnDVVhF3F9z6aJt7TjjVHY9cgCuUaTXobOye6SEXkY2O_i8fLpYHKgABkJj8J7TGVeHp-tDbAYQQxPwZnU24cdGg2gPr9IIQw_YWNjCCGK6QZcfImrS3U9iCihYJ7PNcdjzJ4Byh8qpDlEiOKpO4BIK0rapooDmwXfxs5MYLO14W4a40Kib8-i2T6DrJ5NH--6GdmaNoy7oweyw7CHigXbveQCRSZrTqT498BYUMaa6L6rvuTtB1oRl-mIkmVn3ZQ",
    "expires_in": 300,
    "refresh_expires_in": 1800,
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI0ZTMxMjI3YS1jNzdlLTQ1YjYtYjZiZi02NGI5ODVjNmVmMmYifQ.eyJleHAiOjE2Njc4OTU5NTcsImlhdCI6MTY2Nzg5NDE1NywianRpIjoiOTZmNDQwNTAtODlkOC00OTNjLWE1ZjktY2UzOTlmYTdjN2U1IiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDoxMDAwMC9yZWFsbXMvbWluYm94IiwiYXVkIjoiaHR0cDovL2xvY2FsaG9zdDoxMDAwMC9yZWFsbXMvbWluYm94Iiwic3ViIjoiY2I0NWFlY2EtOTczMC00YmVkLWE5MzktNzFhOGViMDg4Mzc2IiwidHlwIjoiUmVmcmVzaCIsImF6cCI6ImV4YW1wbGUtbGVhcm5pbmciLCJzZXNzaW9uX3N0YXRlIjoiMDYxZTQ4ODUtZGYxOS00ZTU5LTljZGMtZjY1YTMyNGQ2ZTFiIiwic2NvcGUiOiJwcm9maWxlIGVtYWlsIiwic2lkIjoiMDYxZTQ4ODUtZGYxOS00ZTU5LTljZGMtZjY1YTMyNGQ2ZTFiIn0.gvtSoZ_cVmKsp_66E5Ebz5YBKCH2peFKo-ZvTD-Bdg4",
    "token_type": "Bearer",
    "not-before-policy": 0,
    "session_state": "061e4885-df19-4e59-9cdc-f65a324d6e1b",
    "scope": "profile email"
}
```



### 3. 访问资源

```bash
curl -H "Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI5eUFlalpDenlfVm1UeEY4WjRBc0tJNThrd2FDRXlsSUFHd1htU2YzYXRFIn0.eyJleHAiOjE2Njc4OTQ0NTcsImlhdCI6MTY2Nzg5NDE1NywianRpIjoiOTY3MTcxZmYtNTljOS00NzUxLTk4YmMtYmNhNjBiYzNmZWExIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDoxMDAwMC9yZWFsbXMvbWluYm94IiwiYXVkIjoiYWNjb3VudCIsInN1YiI6ImNiNDVhZWNhLTk3MzAtNGJlZC1hOTM5LTcxYThlYjA4ODM3NiIsInR5cCI6IkJlYXJlciIsImF6cCI6ImV4YW1wbGUtbGVhcm5pbmciLCJzZXNzaW9uX3N0YXRlIjoiMDYxZTQ4ODUtZGYxOS00ZTU5LTljZGMtZjY1YTMyNGQ2ZTFiIiwiYWNyIjoiMSIsInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsInVtYV9hdXRob3JpemF0aW9uIiwidXNlciIsImRlZmF1bHQtcm9sZXMtbWluYm94Il19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJwcm9maWxlIGVtYWlsIiwic2lkIjoiMDYxZTQ4ODUtZGYxOS00ZTU5LTljZGMtZjY1YTMyNGQ2ZTFiIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInByZWZlcnJlZF91c2VybmFtZSI6Inl1cWl5dSIsImdpdmVuX25hbWUiOiIiLCJmYW1pbHlfbmFtZSI6IiIsImVtYWlsIjoieXVxaXl1QGdtYWlsLmNvbSJ9.eBCxbU0tvPqF7Url6J2IxGceLPZyINiWl-7Aj4TR-oGLVObioNyb854rp3mw2gkI6snGPOCaszGpHANLMNvRQbnDVVhF3F9z6aJt7TjjVHY9cgCuUaTXobOye6SEXkY2O_i8fLpYHKgABkJj8J7TGVeHp-tDbAYQQxPwZnU24cdGg2gPr9IIQw_YWNjCCGK6QZcfImrS3U9iCihYJ7PNcdjzJ4Byh8qpDlEiOKpO4BIK0rapooDmwXfxs5MYLO14W4a40Kib8-i2T6DrJ5NH--6GdmaNoy7oweyw7CHigXbveQCRSZrTqT498BYUMaa6L6rvuTtB1oRl-mIkmVn3ZQ" localhost:8080/customer
```

